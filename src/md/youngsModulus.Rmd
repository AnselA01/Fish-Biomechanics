---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)

source("./src/script/youngsModulus.R")
source("./src/script/data.R")
source("./src/script/plot.R")
```

```{r}
bones <- data.fetch()
```

```{r}
nbones <- length(bones)
results <- tibble()
```


```{r}


max.slopes <- unlist(lapply(bones, function(bone) {
  return(ym.calculate(bone, "max")$slope)
}))

inflection.slopes <- unlist(lapply(bones, function(bone) {
  return(ym.calculate(bone, method = "inflection")$slope)
}))

fds.slopes <- unlist(lapply(bones, function(bone) {
  return(ym.calculate(bone, method = "fds")$slope)
}))

max.strain <- unlist(lapply(bones, function(bone) {
  return(ym.calculate(bone, method = "max")$strain)
}))

inflection.strain <- unlist(lapply(bones, function(bone) {
  return(ym.calculate(bone, method = "inflection")$strain)
}))

FDS.strain <- unlist(lapply(bones, function(bone) {
  return(ym.calculate(bone, method = "fds")$strain)
}))


results <- data.frame(
  max.slopes,
  inflection.slopes,
  fds.slopes,
  max.strain,
  inflection.strain,
  fds.strain
)

results <- results |>
  mutate(across(everything(), ~ as.numeric(.)))
```

```{r}
# results |>
#   ggplot(aes(x = fds, y = maxSlope)) +
#   geom_point() + 
#   coord_fixed() # square axes
# 
# # hm
# results |>
#   ggplot(aes(x = fds.min, y = maxSlope.min)) +
#   geom_point() + 
#   coord_fixed() # square axes
```

```{r}
results <- tibble()
max.slope <- vector()
max.strain <- vector()
inflection.slope <- vector()
inflection.strain <- vector()
fds.slope <- vector()
fds.strain <- vector()
```


```{r}
loop(for (bone in data.generator()) {
  max <- ym.calculate(bone, method = "max")
  inflection <- ym.calculate(bone, method = "inflection")
  fds <- ym.calculate(bone, method = "fds")
  
  max.slope <- append(max.slope, max$slope)
  max.strain <- append(max.strain, max$strain)
  inflection.slope <- append(inflection.slope, inflection$slope)
  inflection.strain <- append(inflection.strain, inflection$strain)
  fds.slope <- append(fds.slope, fds$slope)
  fds.strain <- append(fds.strain, fds$strain)
  
  slopes.label <- paste(
    "<b style=color:red;>Max:</b> ",
    round(max$slope, 1),
    "<br>",
    "<b style=color:green;>Inflection:</b>",
    "&nbsp;&nbsp;&nbsp;&nbsp;",
    round(inflection$slope, 1),
    "<br>",
    "<b style='color:blue;'>FDS:</b>",
    round(fds$slope, 1)
  )
  
  print(plot.plot(bone, layers = list(
    geom_vline(xintercept = max$strain, color = "red"),
    geom_vline(xintercept = inflection$strain, color = "green"),
    geom_vline(xintercept = fds$strain, color = "blue"),
    labs(subtitle = slopes.label)
  )))
  #Sys.sleep(some number of seconds) # slow it down
})
```




