---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)

source("./src/script/youngsModulus.R")
source("./src/script/data.R")
source("./src/script/plot.R")
```

## troublemakers
```{r}
pf09ut4 <- data.fetch(fish_numbers = c(9), segments = c("ut"), trials = c(4))
pf09ut4.max <- ym.calculate(pf09ut4, method = "max")

pf20lt3 <- data.fetch(fish_numbers = c(20), segments = c("lt"), trials = c(3))
pf20lt3.max <- ym.calculate(pf20lt3, method = "max")
```

```{r}
pf15cp2 <- data.fetch(fish_numbers = c(15), segments = c("cp"), trials = c(2))
pf15cp2.max <- ym.calculate(pf15cp2, method = "inflection")

```


## gather results
```{r}
max.slope <- vector()
max.strain <- vector()
inflection.slope <- vector()
inflection.strain <- vector()
fds.slope <- vector()
fds.strain <- vector()
names <- vector()
```

```{r}
loop(for (bone in data.generator()) {
  max <- ym.calculate(bone, method = "max")
  if (is.null(max)) next
  inflection <- ym.calculate(bone, method = "inflection")
  if (is.null(inflection)) next
  fds <- ym.calculate(bone, method = "fds")
  if (is.null(fds)) next
  
  max.slope <- append(max.slope, max$slope)
  max.strain <- append(max.strain, max$strain)
  inflection.slope <- append(inflection.slope, inflection$slope)
  inflection.strain <- append(inflection.strain, inflection$strain)
  fds.slope <- append(fds.slope, fds$slope)
  fds.strain <- append(fds.strain, fds$strain)
  names <- append(names, max$name)
  
  slopes.label <- paste(
    "<b style=color:red;>Max:</b> ",
    round(max$slope, 1),
    "<br>",
    "<b style=color:green;>Inflection:</b>",
    round(inflection$slope, 1),
    "<br>",
    "<b style='color:blue;'>FDS:</b>",
    round(fds$slope, 1)
  )
  
  print(plot.plot(bone, layers = list(
    geom_vline(xintercept = max$strain, color = "red"),
    geom_vline(xintercept = inflection$strain, color = "green"),
    geom_vline(xintercept = fds$strain, color = "blue"),
    labs(subtitle = slopes.label)
  )))
  #Sys.sleep(some number of seconds) # adjust for your viewing pleasure
})
```

```{r}
results <- tibble(names, max.slope, max.strain, inflection.slope, inflection.strain, fds.slope, fds.strain)
write_csv(results, "./data/youngs-modulus-results/results.csv")
```







