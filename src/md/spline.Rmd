```{r}
library(splines)
```


```{r}
pf09cp01 <- read_tsv("data/pf09/pf09cp01.csv", skip = 15)

area = 3.203110e-06
length_initial = 2.60
load = 0.8
data_clean(pf09cp01, area, length_initial, load)
```

```{r}
cp01spline_model <- lm(Stress ~ ns(Strain, df = 10), data = pf09cp01)

pf09cp01$spline_fit <- predict(cp01spline_model)
ggplot(pf09cp01, aes(x = Strain)) +
  geom_point(aes(y = Stress)) +
  geom_line(aes(y = spline_fit), color = "blue") + 
  theme_minimal()

mt02spline_model <- lm(Stress ~ ns(Strain, df = 10), data = pf09mt02)

pf09mt02$spline_fit <- predict(mt02spline_model)
ggplot(pf09mt02, aes(x = Strain)) +Tg
  geom_point(aes(y = Stress)) +
  geom_line(aes(y = spline_fit), color = "blue") + 
  theme_minimal()
```

```{r}
loop(for (fish in data.generator("./data", 9)) {
  fish <- fish %>% filter(Strain < 0.2)
  basis_mat <- ns(fish$Strain, df = 5)
  spline_model <- lm(Stress ~ basis_mat, data = fish)
  fish$spline_fit <- predict(spline_ model)
  plot <- ggplot(fish, aes(x = Strain)) +
    geom_point(aes(y = Stress)) +
    geom_line(aes(y = spline_fit), color = "blue") + 
    theme_minimal()
  
  print(paste("Fish number: ", fish$Individual, ", Segment: ",  fish$Segment, ", Trial Number: ", fish$Trial, sep = ""))
  print(plot)
})
```



```{r}
cp01spline_model <- lm(Stress ~ ns(Strain, df = 10), data = pf09cp01)

# Create a sequence of values for Strain for prediction
strain_seq <- seq(min(pf09cp01$Strain), max(pf09cp01$Strain), length.out = 100)

# Predict fitted values
fitted_values <- predict(cp01spline_model, newdata = data.frame(Strain = strain_seq))

# Calculate numerical derivatives
# Using finite difference method for derivative
delta <- 1e-5  # A small number for numerical differentiation
predicted_derivative <- (predict(cp01spline_model, newdata = data.frame(Strain = strain_seq + delta)) -
                          predict(cp01spline_model, newdata = data.frame(Strain = strain_seq - delta))) / (2 * delta)

predicted_second_derivative <- (predict(cp01spline_model, newdata = data.frame(Strain = strain_seq + delta)) +
                                  predict(cp01spline_model, newdata = data.frame(Strain = strain_seq - delta)) -
                                  2 * fitted_values) / (delta^2)

# Combine results
results <- data.frame(Strain = strain_seq, Fitted = fitted_values, 
                      First_Derivative = predicted_derivative, 
                      Second_Derivative = predicted_second_derivative)

# View the results
head(results)
```